#!/usr/bin/env python3
"""
UC-F05 Performance and Validation Test Script
Tests KPIs de Recurrencia endpoints for performance and edge cases
"""

import requests
import time
import json
import sys

BASE_URL = 'http://localhost:8000'

def test_endpoint(name, url, expected_status=200, timeout=30):
    """Test a single endpoint and return results"""
    print(f'\nTesting: {name}')
    print(f'URL: {url}')
    
    try:
        start_time = time.time()
        response = requests.get(url, timeout=timeout)
        elapsed = time.time() - start_time
        
        print(f'Status: {response.status_code}')
        print(f'Response time: {elapsed:.2f}s')
        print(f'Content-Type: {response.headers.get("content-type", "N/A")}')
        
        if response.status_code == expected_status:
            print('‚úì Status OK')
            if response.headers.get('content-type', '').startswith('application/json'):
                data = response.json()
                return True, data, elapsed
            else:
                return True, response.text, elapsed
        else:
            print(f'‚úó Status mismatch (expected {expected_status})')
            print(f'Response: {response.text[:200]}')
            return False, response.text, elapsed
            
    except Exception as e:
        print(f'‚úó Error: {e}')
        return False, str(e), 0

def main():
    print('=== UC-F05: KPIs de Recurrencia - Performance Test ===')
    
    results = []
    
    # Test 1: Recurrence analysis endpoint
    print('\n1. Testing /api/v1/analysis/recurrence')
    success, data, elapsed = test_endpoint(
        'Recurrence Analysis',
        f'{BASE_URL}/api/v1/analysis/recurrence?bbox=-65,-32,-63,-30&start_date=2019-01-01&end_date=2024-02-09'
    )
    
    if success and isinstance(data, dict):
        features = data.get('features', [])
        summary = data.get('summary', {})
        print(f'   Features returned: {len(features)}')
        print(f'   Summary: {summary}')
        
        if elapsed < 2.0:
            print('   ‚úì Performance OK (< 2s)')
        else:
            print('   ‚ö† Performance warning (> 2s)')
    
    results.append(('UC-F05-Recurrence', success, elapsed))
    
    # Test 2: Trends analysis endpoint
    print('\n2. Testing /api/v1/analysis/trends')
    success, data, elapsed = test_endpoint(
        'Trends Analysis',
        f'{BASE_URL}/api/v1/analysis/trends?province=C√≥rdoba&start_year=2015&end_year=2024'
    )
    
    if success and isinstance(data, dict):
        province = data.get('province', 'N/A')
        annual_fires = data.get('annual_fires', [])
        trend = data.get('trend_analysis', {})
        print(f'   Province: {province}')
        print(f'   Annual fires points: {len(annual_fires)}')
        print(f'   Trend: {trend.get("direction", "N/A")} (slope: {trend.get("slope", "N/A")})')
        
        if elapsed < 2.0:
            print('   ‚úì Performance OK (< 2s)')
        else:
            print('   ‚ö† Performance warning (> 2s)')
    
    results.append(('UC-F05-Trends', success, elapsed))
    
    # Test 3: Edge cases
    print('\n3. Testing edge cases')
    
    # Large bbox (> 10¬∞)
    print('   3a. Large bbox test (> 10¬∞)')
    success, data, elapsed = test_endpoint(
        'Large BBOX',
        f'{BASE_URL}/api/v1/analysis/recurrence?bbox=-70,-40,-60,-30&start_date=2019-01-01',
        expected_status=400
    )
    
    if success:
        print('      ‚úì Large bbox correctly rejected')
    else:
        print('      ‚ö† Large bbox not properly validated')
    
    results.append(('UC-F05-LargeBBOX', success == False, elapsed))  # Should fail
    
    # Long time range (> 10 years)
    print('   3b. Long time range test (> 10 years)')
    success, data, elapsed = test_endpoint(
        'Long Time Range',
        f'{BASE_URL}/api/v1/analysis/trends?province=C√≥rdoba&start_year=2000&end_year=2024'
    )
    
    if success and isinstance(data, dict):
        period = data.get('period', {})
        years_covered = period.get('end', 0) - period.get('start', 0)
        print(f'      Years covered: {years_covered}')
        print('      ‚úì Long range handled with aggregation')
    
    results.append(('UC-F05-LongRange', success, elapsed))
    
    # Summary
    print('\n=== SUMMARY ===')
    passed = sum(1 for _, success, _ in results if success)
    total = len(results)
    
    print(f'Tests passed: {passed}/{total}')
    
    for name, success, elapsed in results:
        status = '‚úì' if success else '‚úó'
        print(f'  {status} {name}: {elapsed:.2f}s')
    
    if passed == total:
        print('\nüéâ All UC-F05 tests passed!')
        return 0
    else:
        print(f'\n‚ùå {total - passed} tests failed')
        return 1

if __name__ == '__main__':
    sys.exit(main())
